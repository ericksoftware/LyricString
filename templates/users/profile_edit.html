{% extends "base.html" %}

{% load static %}

{% block title %}Edit Profile - LyricString{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile_edit.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-user-edit"></i> Edit Profile</h1>
    <p>Update your profile information and preferences</p>
</div>

<div class="edit-container">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Profile Picture Section -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-camera"></i> Profile Picture
            </h2>
            
            <div class="avatar-section">
                <div class="current-avatar" id="avatarPreview">
                    {% if user_form.instance.profile_picture %}
                    <img src="{{ user_form.instance.profile_picture.url }}" alt="Current profile picture" id="currentAvatar">
                    {% else %}
                    <i class="fas fa-user" id="defaultAvatarIcon"></i>
                    {% endif %}
                    <div class="avatar-overlay">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                
                <div class="file-input-wrapper">
                    {{ user_form.profile_picture }}
                    <label for="id_profile_picture" class="file-input-label">
                        <i class="fas fa-upload"></i> Change Picture
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="id_bio" class="form-label">Bio</label>
                {{ user_form.bio }}
                <div class="form-help">Maximum 500 characters</div>
                <div class="char-counter" id="bioCharCounter">0/500</div>
            </div>
        </div>

        <!-- Musical Preferences -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-music"></i> Musical Preferences
            </h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_skill_level" class="form-label">Skill Level</label>
                    {{ user_form.skill_level }}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Instruments You Play</label>
                <div class="checkbox-group" id="instrumentsGroup">
                    {{ pref_form.instruments_played }}
                </div>
                <button type="button" class="btn-add-more" id="addInstrumentBtn">+ Add Instrument</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Music Genres You Enjoy</label>
                <div class="checkbox-group" id="genresGroup">
                    {{ pref_form.favorite_genres }}
                </div>
                <button type="button" class="btn-add-more" id="addGenreBtn">+ Add Genre</button>
            </div>
        </div>

        <!-- Location & Contact -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-map-marker-alt"></i> Location & Contact
            </h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_location" class="form-label">Location</label>
                    {{ user_form.location }}
                    <div class="location-suggestions" id="locationSuggestions"></div>
                </div>
                
                <div class="form-group">
                    <label for="id_website" class="form-label">Website/Portfolio</label>
                    {{ user_form.website }}
                    <div class="website-preview" id="websitePreview"></div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_social_media" class="form-label">Social Media</label>
                    <div class="social-media-inputs">
                        {% for field in user_form.social_media_fields %}
                            <div class="social-input-group">
                                <select class="social-platform">
                                    <option value="twitter">Twitter</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="youtube">YouTube</option>
                                </select>
                                <input type="text" class="social-username" placeholder="Username" value="{{ field.value }}">
                            </div>
                        {% endfor %}
                        <button type="button" class="btn-add-social" id="addSocialBtn">+ Add Social Media</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Settings -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-shield-alt"></i> Privacy Settings
            </h2>
            
            <div class="privacy-section">
                <div class="privacy-title">
                    <i class="fas fa-eye"></i> Profile Visibility
                </div>
                
                <div class="switch-group">
                    <span class="switch-label">Make profile public</span>
                    <label class="switch">
                        {{ pref_form.public_profile }}
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="switch-group">
                    <span class="switch-label">Show liked songs</span>
                    <label class="switch">
                        {{ pref_form.show_liked_songs }}
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="switch-group">
                    <span class="switch-label">Show activity feed</span>
                    <label class="switch">
                        {{ pref_form.show_activity }}
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-bell"></i> Notification Preferences
            </h2>
            
            <div class="switch-group">
                <span class="switch-label">Email notifications</span>
                <label class="switch">
                    {{ pref_form.email_notifications }}
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="saveChangesBtn">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <a href="{% url 'profile' %}" class="btn btn-outline">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dynamic avatar preview
    const avatarInput = document.querySelector('#id_profile_picture');
    const avatarPreview = document.querySelector('#avatarPreview');
    const currentAvatar = document.querySelector('#currentAvatar');
    const defaultAvatarIcon = document.querySelector('#defaultAvatarIcon');
    
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (currentAvatar) {
                        currentAvatar.src = e.target.result;
                    } else {
                        if (defaultAvatarIcon) defaultAvatarIcon.style.display = 'none';
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Profile preview';
                        img.id = 'currentAvatar';
                        avatarPreview.insertBefore(img, avatarPreview.firstChild);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Bio character counter
    const bioTextarea = document.querySelector('#id_bio');
    const charCounter = document.querySelector('#bioCharCounter');
    
    if (bioTextarea && charCounter) {
        bioTextarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            charCounter.textContent = `${currentLength}/500`;
            if (currentLength > 500) {
                charCounter.style.color = 'red';
            } else {
                charCounter.style.color = '';
            }
        });
        
        // Initialize counter
        charCounter.textContent = `${bioTextarea.value.length}/500`;
    }

    // Add more instruments/genres dynamically
    const addInstrumentBtn = document.querySelector('#addInstrumentBtn');
    const addGenreBtn = document.querySelector('#addGenreBtn');
    
    if (addInstrumentBtn) {
        addInstrumentBtn.addEventListener('click', function() {
            // Implementation for adding new instrument input
            console.log('Add instrument functionality to be implemented');
        });
    }
    
    if (addGenreBtn) {
        addGenreBtn.addEventListener('click', function() {
            // Implementation for adding new genre input
            console.log('Add genre functionality to be implemented');
        });
    }

    // Add social media field dynamically
    const addSocialBtn = document.querySelector('#addSocialBtn');
    if (addSocialBtn) {
        addSocialBtn.addEventListener('click', function() {
            const socialInputs = document.querySelector('.social-media-inputs');
            const newSocialGroup = document.createElement('div');
            newSocialGroup.className = 'social-input-group';
            newSocialGroup.innerHTML = `
                <select class="social-platform">
                    <option value="twitter">Twitter</option>
                    <option value="instagram">Instagram</option>
                    <option value="facebook">Facebook</option>
                    <option value="youtube">YouTube</option>
                </select>
                <input type="text" class="social-username" placeholder="Username">
                <button type="button" class="btn-remove-social">&times;</button>
            `;
            socialInputs.insertBefore(newSocialGroup, addSocialBtn);
            
            // Add remove functionality
            newSocialGroup.querySelector('.btn-remove-social').addEventListener('click', function() {
                socialInputs.removeChild(newSocialGroup);
            });
        });
    }

    // Initialize existing remove buttons for social media
    document.querySelectorAll('.btn-remove-social').forEach(btn => {
        btn.addEventListener('click', function() {
            this.parentElement.remove();
        });
    });

    // Location suggestions
    const locationInput = document.querySelector('#id_location');
    const locationSuggestions = document.querySelector('#locationSuggestions');
    
    if (locationInput && locationSuggestions) {
        locationInput.addEventListener('input', function() {
            if (this.value.length > 2) {
                // Here you would typically fetch suggestions from an API
                // For demo purposes, we'll just show some mock suggestions
                locationSuggestions.innerHTML = `
                    <div class="suggestion">${this.value}, City</div>
                    <div class="suggestion">${this.value}, State</div>
                    <div class="suggestion">${this.value} County</div>
                `;
                locationSuggestions.style.display = 'block';
            } else {
                locationSuggestions.style.display = 'none';
            }
        });
        
        // Hide suggestions when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (e.target !== locationInput) {
                locationSuggestions.style.display = 'none';
            }
        });
        
        // Select suggestion
        locationSuggestions.addEventListener('click', function(e) {
            if (e.target.classList.contains('suggestion')) {
                locationInput.value = e.target.textContent;
                locationSuggestions.style.display = 'none';
            }
        });
    }

    // Website preview
    const websiteInput = document.querySelector('#id_website');
    const websitePreview = document.querySelector('#websitePreview');
    
    if (websiteInput && websitePreview) {
        websiteInput.addEventListener('input', function() {
            if (this.value) {
                let url = this.value;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                websitePreview.innerHTML = `<a href="${url}" target="_blank">Preview: ${url}</a>`;
            } else {
                websitePreview.innerHTML = '';
            }
        });
    }
});
</script>
{% endblock %}